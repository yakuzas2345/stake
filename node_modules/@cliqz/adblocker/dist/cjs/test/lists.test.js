"use strict";
/*!
 * Copyright (c) 2017-present Cliqz GmbH. All rights reserved.
 *
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const chai_1 = require("chai");
require("mocha");
const lists_1 = require("../src/lists");
const config_1 = require("../src/config");
describe('#getLinesWithFilters', () => {
    it('get not lines if empty', () => {
        (0, chai_1.expect)((0, lists_1.getLinesWithFilters)('')).to.eql(new Set());
    });
    it('handle single filter', () => {
        (0, chai_1.expect)((0, lists_1.getLinesWithFilters)('||foo.com$badfilter')).to.eql(new Set(['||foo.com$badfilter']));
    });
    it('handle multiple filters', () => {
        (0, chai_1.expect)((0, lists_1.getLinesWithFilters)('||foo.com$badfilter\n||bar.co.uk')).to.eql(new Set(['||foo.com$badfilter', '||bar.co.uk']));
    });
    it('ignore empty lines', () => {
        (0, chai_1.expect)((0, lists_1.getLinesWithFilters)(`

||foo.com


bar.co.uk^*baz

      `)).to.eql(new Set(['||foo.com', 'bar.co.uk^*baz']));
    });
    it('ignore comments', () => {
        (0, chai_1.expect)((0, lists_1.getLinesWithFilters)(`
[Adblock Plus 2.0]
! this is a comment
||foo.com


!bar.co.uk^*baz

      `)).to.eql(new Set(['||foo.com']));
    });
});
describe('#parseFilters', () => {
    it('handle network filters', () => {
        (0, chai_1.expect)((0, lists_1.parseFilters)('')).to.have.property('networkFilters').that.have.lengthOf(0);
        (0, chai_1.expect)((0, lists_1.parseFilters)('||foo.com')).to.have.property('networkFilters').that.have.lengthOf(1);
    });
    it('handle cosmetic filters', () => {
        (0, chai_1.expect)((0, lists_1.parseFilters)('')).to.have.property('cosmeticFilters').that.have.lengthOf(0);
        (0, chai_1.expect)((0, lists_1.parseFilters)('###foo')).to.have.property('cosmeticFilters').that.have.lengthOf(1);
    });
    it('ignores preprocessors', () => {
        const result = (0, lists_1.parseFilters)(`!#if true
    ||foo.com
!#endif`);
        (0, chai_1.expect)(result).to.have.property('preprocessors').that.have.lengthOf(0);
        (0, chai_1.expect)(result).and.to.have.property('networkFilters').that.have.lengthOf(1);
    });
    context('with loadPreprocessors config', () => {
        const config = new config_1.default({
            loadPreprocessors: true,
        });
        it('ignores empty preprocessors', () => {
            (0, chai_1.expect)((0, lists_1.parseFilters)(`!#if true
  !#endif`, config))
                .to.have.property('preprocessors')
                .that.have.lengthOf(0);
        });
        it('handle preprocessors', () => {
            const result = (0, lists_1.parseFilters)(`!#if true
        ||foo.com
!#endif`, config);
            (0, chai_1.expect)(result).to.have.property('preprocessors').that.have.lengthOf(1);
            (0, chai_1.expect)(result).to.have.property('networkFilters').that.have.lengthOf(1);
        });
    });
});
describe('#generateDiff', () => {
    it('diff between empty strings', () => {
        (0, chai_1.expect)((0, lists_1.generateDiff)('', '')).to.eql({
            added: [],
            removed: [],
            preprocessors: {},
        });
    });
    it('same filters', () => {
        (0, chai_1.expect)((0, lists_1.generateDiff)(`
||foo.com

bar.baz
*ads*

    `, `
! comment

bar.baz
*ads*
||foo.com
    `)).to.eql({
            added: [],
            removed: [],
            preprocessors: {},
        });
    });
    it('add filters from empty', () => {
        (0, chai_1.expect)((0, lists_1.generateDiff)('', '||foo.com')).to.eql({
            added: ['||foo.com'],
            removed: [],
            preprocessors: {},
        });
    });
    it('remove filters', () => {
        (0, chai_1.expect)((0, lists_1.generateDiff)('||foo.com', '')).to.eql({
            added: [],
            removed: ['||foo.com'],
            preprocessors: {},
        });
    });
    it('handle filter renaming', () => {
        (0, chai_1.expect)((0, lists_1.generateDiff)('||foo.com$domain=foo.com|bar.com', '||foo.com$domain=bar.com|foo.com')).to.eql({
            added: [],
            removed: [],
            preprocessors: {},
        });
    });
    it('handle preprocessors', () => {
        const config = new config_1.default({
            loadPreprocessors: true,
        });
        (0, chai_1.expect)((0, lists_1.generateDiff)('', `!#if true
!#endif`, config)).to.eql({
            added: [],
            removed: [],
            preprocessors: {},
        });
        (0, chai_1.expect)((0, lists_1.generateDiff)('', `!#if true
||foo.com
!#endif`, config)).to.eql({
            added: ['||foo.com'],
            removed: [],
            preprocessors: {
                true: {
                    added: ['||foo.com'],
                    removed: [],
                },
            },
        });
        (0, chai_1.expect)((0, lists_1.generateDiff)(`!#if true
||foo.com
!#endif`, '', config)).to.eql({
            added: [],
            removed: ['||foo.com'],
            preprocessors: {
                true: {
                    added: [],
                    removed: ['||foo.com'],
                },
            },
        });
        (0, chai_1.expect)((0, lists_1.generateDiff)(`||bar.com
!#if true
||foo.com
!#endif`, `||foo.com
!#if true
||bar.com
!#endif`, config)).to.eql({
            added: [],
            removed: [],
            preprocessors: {
                true: {
                    added: ['||bar.com'],
                    removed: ['||foo.com'],
                },
            },
        });
    });
});
describe('#f', () => {
    it('handles CosmeticFilter', () => {
        const filter = (0, lists_1.f) `##.selector`;
        (0, chai_1.expect)(filter).not.to.be.null;
        if (filter !== null) {
            (0, chai_1.expect)(filter.isCosmeticFilter()).to.be.true;
        }
    });
    it('handles NetworkFitler', () => {
        const filter = (0, lists_1.f) `||foo.com`;
        (0, chai_1.expect)(filter).not.to.be.null;
        if (filter !== null) {
            (0, chai_1.expect)(filter.isNetworkFilter()).to.be.true;
        }
    });
    it('returns null for invalid filter', () => {
        (0, chai_1.expect)((0, lists_1.f) `#$#~~~`).to.be.null;
    });
});
describe('#mergeDiffs', () => {
    it('merges one diff', () => {
        const diff = {
            added: ['||foo.com'],
            removed: ['||bar.com'],
            preprocessors: {},
        };
        (0, chai_1.expect)((0, lists_1.mergeDiffs)([diff])).to.eql(diff);
    });
    it('merges several diffs', () => {
        (0, chai_1.expect)((0, lists_1.mergeDiffs)([
            { added: ['foo.com', 'baz.com'] },
            { removed: ['foo.com'] },
            { added: ['bar.com'], removed: ['foo.com'] },
            { removed: ['bar.com'] },
        ])).to.eql({
            added: ['baz.com'],
            removed: ['foo.com', 'bar.com'],
            preprocessors: {},
        });
        (0, chai_1.expect)((0, lists_1.mergeDiffs)([
            {
                preprocessors: {
                    true: {
                        added: ['||foo.com'],
                    },
                },
            },
            {
                preprocessors: {
                    true: {
                        added: ['||foo.com', '||bar.com'],
                    },
                },
            },
        ])).to.eql({
            added: [],
            removed: [],
            preprocessors: {
                true: {
                    added: ['||foo.com', '||bar.com'],
                    removed: [],
                },
            },
        });
    });
});
//# sourceMappingURL=lists.test.js.map